{
    "tags": [
        "authorization",
        "identityserver4",
        "blazor",
        "blazor-webassembly",
        "webassembly"
    ],
    "owner": {
        "reputation": 31,
        "user_id": 13740734,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/9445cb8c713f40b9a33ac09f1ca4f18d?s=128&d=identicon&r=PG&f=1",
        "display_name": "Don328",
        "link": "https://stackoverflow.com/users/13740734/don328"
    },
    "is_answered": true,
    "view_count": 1603,
    "answer_count": 2,
    "score": 3,
    "last_activity_date": 1604050968,
    "creation_date": 1593151538,
    "last_edit_date": 1593222291,
    "question_id": 62588935,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/62588935/blazor-wasm-hosted-could-not-load-settings-from-configuration-testapp-client",
    "title": "Blazor wasm hosted &#39;Could not load settings from configuration/TestApp.Client - (AuthenticationService.js)",
    "body": "<h1>Issue Summary</h1>\n<hr />\n<h2>Setup</h2>\n<p>Boilerplate Blazor hosted wasm app with Authentication using: <code>dotnet new blazorwasm -ho -au Individual -o TestApp</code></p>\n<p>I changed the default database to use MySql</p>\n<p>I ran the application on my development machine and tested that I could create users, login, etc. Everything works fine in my development environment.</p>\n<p>After deploying site loads, but shows 'Authorizing' at the top of the main body and throws the 'Unhandled error has occured' message at the bottom of the browser along with the error messages in the browser console as shown below</p>\n<hr />\n<h2>Deployment</h2>\n<h3>Server environment</h3>\n<p>Raspberry Pi4(8gb) running Ubuntu Server 20.04 (64bit) with Apache2</p>\n<h3>Deployment method</h3>\n<p>After pushing changes to Github, I do a fetch and a pull in a remote repo on my server</p>\n<p>I then make sure the project builds and publish to <code>/var/www/[MyWebAddress]/TestApp</code> using: <code>dotnet publish -o /var/www/[my web address]/TestApp --no-self-contained -r linux-x64</code></p>\n<p>I copied my apache site conf file ([my web address].conf) straight from <a href=\"https://docs.microsoft.com/en-us/aspnet/core/blazor/host-and-deploy/webassembly?view=aspnetcore-3.1\" rel=\"nofollow noreferrer\">Microsoft docs</a>:</p>\n<pre><code>&lt;VirtualHost *:80&gt;\n    ServerName www.[my web address]\n    ServerAlias *.[my web address]\n\n    DocumentRoot &quot;/var/www/[my web address]/TestApp&quot;\n    ErrorDocument 404 /wwwroot/index.html\n\n    AddType application/wasm .wasm\n    AddType application/octet-stream .dll\n\n    &lt;Directory &quot;/var/www/[my web address]/TestApp&quot;&gt;\n        Options -Indexes\n        AllowOverride None\n    &lt;/Directory&gt;\n\n    &lt;IfModule mod_deflate.c&gt;\n        AddOutputFilterByType DEFLATE text/css\n        AddOutputFilterByType DEFLATE application/javascript\n        AddOutputFilterByType DEFLATE text/html\n        AddOutputFilterByType DEFLATE application/octet-stream\n        AddOutputFilterByType DEFLATE application/wasm\n        &lt;IfModule mod_setenvif.c&gt;\n        BrowserMatch ^Mozilla/4 gzip-only-text/html\n        BrowserMatch ^Mozilla/4.0[678] no-gzip\n        BrowserMatch bMSIE !no-gzip !gzip-only-text/html\n    &lt;/IfModule&gt;\n</code></pre>\n<h3>Troubleshooting insights</h3>\n<p>Prior to trying this setup, I did an identical deployment, but didn't use authentication or a database connection. I just deployed a boilerplate Blazorwasm hosted app using the same method described above and tested it on the server. Everything worked including the <code>FetchData</code> and <code>Counter</code> pages. This makes me pretty sure that my deployment method works and that it is something to do with IdentityServer that is causing the issue.</p>\n<p>In order to test this, I am using my laptop connected to a wireless hotspot served from my phone. This allows me to access my local server from an external network (just using my phone with the wifi disabled works, but I can't open the browser tools for troubleshooting on a mobile device). I'm getting slightly different errors from different browsers but they are similar to these that were produced by Firefox:</p>\n<pre><code>Error: &quot;Failed to start platform. Reason: AbortError: The operation was aborted. &quot;\n    v https://[my web address]/ framework/blazor.webassembly.js:1\n    u https://[my web address]/ framework/blazor.webassembly.js:1\n    u https://[my web address]/ framework/blazor.webassembly.js:1\n    u https://[my web address]/ framework/blazor.webassembly.js:1\nAbortError: The operation was aborted.\n</code></pre>\n<pre><code>crit: Microsoft.AspNetCore.Components.WebAssembly.REnderingWebAssemblyREenderer[100]\n      Unhandled exception rendering component: Could not load settings form '_configuration/TestSite.Client'\n      createUserManager@https://[my web address]/ content/Microsoft.AspNetCore.Components.WebAssembly.Authentication/AuthenticationService.js:1:5893\n\n[ continued error messages omitted ]\n</code></pre>\n<ul>\n<li>The main layout is loaded. I can see the side bar and the nav menu. Clicking on the sidebar links changes the url in the address bar but routing does not occur</li>\n<li>The nav menu only shows the 'About' nav link. ('Login' and 'Register' are missing)</li>\n</ul>\n<hr />\n<p>I wouldn't be the least bit surprised if this is the result of a very basic mistake, but I also wouldn't be surprised if I have some critical piece that isn't compatible with what I'm trying to do. I'm just learning, so please don't assume that I have done all of the obvious stuff. It may not be that obvious to me.</p>\n<hr />\n<hr />\n<h2>Progress</h2>\n<p>From the link provided by <a href=\"https://stackoverflow.com/users/921054/pavel-voronin\">Pavel Voronin</a> in the comment below, I found a solution that solves the initial problem:</p>\n<p><em>From <a href=\"https://github.com/dotnet/aspnetcore/issues/21327\" rel=\"nofollow noreferrer\">Github issues</a></em></p>\n<blockquote>\n<p>In my case the error showed up even when I started the server project.\nMy Identity Server is not installed on the same server where my app is\nlocated.</p>\n<p>So, I made some changes in Program.cs (client)</p>\n<pre><code>public static async Task Main(string[] args)\n{\n    var builder = WebAssemblyHostBuilder.CreateDefault(args);\n    builder.RootComponents.Add&lt;App&gt;(&quot;app&quot;);\n    builder.Services.AddHttpClient(&quot;BlazorApp1.ServerAPI&quot;, client =&gt;  \n    client.BaseAddress = new Uri(builder.HostEnvironment.BaseAddress))\n        .AddHttpMessageHandler&lt;BaseAddressAuthorizationMessageHandler&gt;();\n    builder.Services.AddTransient(sp =&gt; \n        sp.GetRequiredService&lt;IHttpClientFactory&gt;() \n        CreateClient(&quot;BlazorApp1.ServerAPI&quot;));\n    //The following line has been disabled\n    //builder.Services.AddApiAuthorization();\n    //In order to authenticate to IS4:\n    builder.Services.AddOidcAuthentication(options =&gt;\n    {\n        builder.Configuration.Bind(&quot;Local&quot;, options.ProviderOptions);\n    });\n\nawait builder.Build().RunAsync();\n}\n</code></pre>\n<p>Also I configure the OpenId settings in <code>appsettings.json</code> with\nAuthority and ClientId. After this changes, the error disappeared.</p>\n<p>Not sure if it's the solution to this error.</p>\n</blockquote>\n<p>After making the changes to the Program file, the page loads as expected without errors</p>\n<p>But when I click on the 'Register' link, there is a brief 'Registration is not supported' message before a redirect back to the index page</p>\n<hr />\n<p>After poking around a bit more, I don't believe this to be a solution and I'm rolling it back</p>\n<p><em>From the example quoted above:</em></p>\n<blockquote>\n<p>My Identity Server is not installed on the same server where my app is located.</p>\n</blockquote>\n<p>This led him to use <code>OIDC</code> instead of <code>ApiAuthentication</code>. This isn't the case for me because my Authentication lives on the Blazor server application that is part of the Blazor 'hosted' template which essentially acts as the api for the project</p>\n<p>One thing I didn't include in my description of my deployment workflow was that I migrate and update the database on the server after pulling from GitHub and building the project in the server repo, just before publishing. I have verified that the database is created and all of the Auth tables exist on the server db</p>\n<p>I also had a theory that it was launching using IIS setting on the server. The tests I was doing in development were using Kestrel. I launched from Visual Studio using IIS and got some similar errors to what I was seeing from the server. So I deleted all of the IIS configuration from the both <code>launchsettings.json</code> files and re-published. No change in behavior</p>\n<hr />\n<h3>What <em>I think</em> I have narrowed out</h3>\n<ul>\n<li>The database connection and configuration, including the connection string</li>\n<li>Port proxy settings in apache2 (unless there is a compression setting or something like that I'm missing)</li>\n</ul>\n<hr />\n<p>I'm pretty sure It has something to do with configuring Identity Server.</p>\n"
}