{
    "tags": [
        ".net",
        ".net-core",
        "amazon-cognito",
        "blazor",
        "blazor-client-side"
    ],
    "owner": {
        "reputation": 33,
        "user_id": 7979810,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/43ee3fccebd7cae5e3ee5171c0c91566?s=128&d=identicon&r=PG&f=1",
        "display_name": "matlodej",
        "link": "https://stackoverflow.com/users/7979810/matlodej"
    },
    "is_answered": true,
    "view_count": 1328,
    "accepted_answer_id": 61848770,
    "answer_count": 3,
    "score": 2,
    "last_activity_date": 1591606210,
    "creation_date": 1589675666,
    "last_edit_date": 1589727173,
    "question_id": 61845477,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/61845477/blazor-webassembly-amazon-cognito",
    "title": "Blazor WebAssembly + Amazon Cognito",
    "body": "<p>I would like to set up a <strong>Blazor</strong> client-side app with authentication through <strong>AWS Cognito</strong>.</p>\n\n<p>When I run the app I'm not redirected to a login page, instead the page says \"Authorizing...\" for a few seconds, while I get this error in the console:</p>\n\n<pre><code>The loading of \u201chttps://blazorapp.auth.eu-central-1.amazoncognito.com/login?\u2026Q&amp;code_challenge_method=S256&amp;prompt=none&amp;response_mode=query\u201d in a frame is denied by \u201cX-Frame-Options\u201c directive set to \u201cDENY\u201c.\nThis error page has no error code in its security info\ninfo: Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2]\n      Authorization failed.\n</code></pre>\n\n<p>Then, the default \"Hello, world!\" index page is shown <strong>(even though as I understand it, it should not be visible to an unauthenticated user based on App.razor definition?)</strong>. If I click on \"Log in\", I get the same error in console, but then after a few seconds the Cognito-hosted login page opens, I am able to log in, I am redirected back to my app, and the app shows the authenticated user's info in top right corner, but the console is a little weird again:</p>\n\n<pre><code>info: Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2]\n      Authorization failed.\ninfo: Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[1]\n      Authorization was successful.\n</code></pre>\n\n<p><strong>Question 1</strong></p>\n\n<p>How can I get rid of these errors and have my app redirect to Cognito login page without ~10s delay?</p>\n\n<p><strong>Question 2</strong></p>\n\n<p>Why is all content in my app visible at all times regardless of whether I'm authenticated or not? It's as if the <code>NotAuthorized</code> node under <code>AuthorizeRouteView</code> in <code>App.razor</code> had no effect at all, unless I am confusing something here</p>\n\n<p><strong>Code:</strong></p>\n\n<p><em>Program.cs</em></p>\n\n<pre><code>builder.Services.AddOidcAuthentication(options =&gt;\n{\n    options.ProviderOptions.Authority = \"https://cognito-idp.{aws-region}.amazonaws.com/{cognito-userpoolid}\";\n    options.ProviderOptions.ClientId = \"{cognito-clientid}\";\n    options.ProviderOptions.ResponseType = \"code\";\n    options.ProviderOptions.RedirectUri = \"https://localhost:44306/authentication/login-callback\";\n    options.ProviderOptions.PostLogoutRedirectUri = \"https://localhost:44306/authentication/logout-callback\";\n});\n</code></pre>\n\n<p><em>App.razor</em> (as created from template, no modifications)</p>\n\n<pre><code>&lt;CascadingAuthenticationState&gt;\n    &lt;Router AppAssembly=\"@typeof(Program).Assembly\"&gt;\n        &lt;Found Context=\"routeData\"&gt;\n            &lt;AuthorizeRouteView RouteData=\"@routeData\" DefaultLayout=\"@typeof(MainLayout)\"&gt;\n                &lt;NotAuthorized&gt;\n                    @if (!context.User.Identity.IsAuthenticated)\n                    {\n                        &lt;RedirectToLogin /&gt;\n                    }\n                    else\n                    {\n                        &lt;p&gt;You are not authorized to access this resource.&lt;/p&gt;\n                    }\n                &lt;/NotAuthorized&gt;\n            &lt;/AuthorizeRouteView&gt;\n        &lt;/Found&gt;\n        &lt;NotFound&gt;\n            &lt;LayoutView Layout=\"@typeof(MainLayout)\"&gt;\n                &lt;p&gt;Sorry, there's nothing at this address.&lt;/p&gt;\n            &lt;/LayoutView&gt;\n        &lt;/NotFound&gt;\n    &lt;/Router&gt;\n&lt;/CascadingAuthenticationState&gt;\n</code></pre>\n\n<p>I have only modified the call to <code>AddOidcAuthentication</code> in <code>Program.cs</code> myself, all other files were populated by Visual Studio when creating a Blazor WebAssembly App with Individual User Accounts.</p>\n\n<p>I am struggling to get this to work and would greatly appreciate any help on this topic</p>\n\n<p><strong>EDIT:</strong></p>\n\n<p>Following @aguafrommars's answer I have published the website to Amazon S3 using static website hosting with Amazon CloudFront as CDN, however, the behavior of the published app is exactly the same as described local behavior</p>\n\n<p>To expand on the questions:</p>\n\n<p><strong>Question 1 expanded:</strong></p>\n\n<p>When the page says \"Authorizing...\" I only get the described error in the console, the Cognito hosted UI is not rendered, only when I click on \"Log in\" I am either redirected (with major delay) to Cognito hosted UI, or authenticated without redirection (if I signed in before), perhaps this GIF will clear things up:</p>\n\n<p><img src=\"https://thumbs.gfycat.com/MeatyRemoteEyelashpitviper-size_restricted.gif\" alt=\"blazor/cognito weird behavior\"></p>\n\n<p>I might be wrong, but isn't the problem that the <strong>Cognito hosted UI is rejecting to be rendered in an iframe</strong>? Can my app redirect to the hosted UI in the first place, like it eventually does? Right now I have to wait while <code>X-Frame-Options</code> error is thrown, click on \"Log in\", wait while another <code>X-Frame-Options</code> error is thrown, and then finally I'm redirected and the flow succeeds (in the gif the UI doesn't show up because I authenticated before in the session)</p>\n\n<p><strong>Question 2 expanded:</strong></p>\n\n<p>The behavior I want to achieve is that if the user is not authenticated, they cannot see any part of the application, instead they are redirected to Cognito hosted UI and only after they are authenticated they can see anything. I tried to play around with <code>Authorize</code> attribute in <code>MainLayout.razor</code>, but the result is always a blank screen, I would like to provide some code and details but I believe the behavior is impacted by errors described in <strong>Question 1</strong>, which is why I would like to sort it out first</p>\n"
}